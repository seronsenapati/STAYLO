<% layout('layouts/boilerplate') %>
<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const listing = JSON.parse('<%- JSON.stringify(listing || {}) %>');
</script>

<div class="container">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/listings">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page"><%= listing.title %></li>
        </ol>
      </nav>
    </div>
  </div>
  
  <div class="row">
    <div class="col-lg-8">
      <div class="property-image mb-4">
        <img
          src="<%= listing.image.url || 'https://placehold.co/800x600?text=No+Image+Available' %>"
          alt="<%= listing.title || 'Listing Image' %>"
          class="show-img img-fluid w-100"
          onerror="this.src='https://placehold.co/800x600?text=Image+Not+Found';"
        />
      </div>
      
      <div class="property-details mb-5">
        <div class="d-flex justify-content-between align-items-start mb-4">
          <div>
            <h1 class="mb-2"><%= listing.title %></h1>
            <div class="d-flex align-items-center text-muted mb-3">
              <i class="ri-map-pin-line me-2"></i>
              <span><%= listing.location %>, <%= listing.country %></span>
            </div>
          </div>
          <div class="text-end">
            <div class="h2 text-primary mb-0">&#8377;<%= listing.price.toLocaleString('en-IN') %></div>
            <div class="text-muted">per night</div>
          </div>
        </div>
        
        <div class="mb-4">
          <h4 class="mb-3">Description</h4>
          <p class="lead"><%= listing.description %></p>
        </div>
        
        <div class="host-info">
          <div class="host-avatar">
            <%= listing.owner.username.charAt(0).toUpperCase() %>
          </div>
          <div>
            <h5>Hosted by <%= listing.owner.username %></h5>
            <p class="text-muted mb-0">Property Owner</p>
          </div>
        </div>
      </div>
      
      <div class="mb-5">
        <h3 class="mb-4">Location</h3>
        <div id="map"></div>
      </div>
      
      <% if (currUser && String(currUser._id) === String(listing.owner._id)) { %>
      <div class="property-actions mb-5">
        <h4 class="mb-3">Manage Property</h4>
        <div class="d-flex gap-3">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-primary">
            <i class="ri-edit-line"></i> Edit Property
          </a>
          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this property?')">
              <i class="ri-delete-bin-line"></i> Delete Property
            </button>
          </form>
        </div>
      </div>
      <% } %>
    </div>
    
    <div class="col-lg-4">
      <div class="sticky-top" style="top: 100px;">
        <% if (listing.reviews.length > 0) { %>
        <div class="reviews-section mb-5">
          <h4 class="mb-4">Guest Reviews (<%= listing.reviews.length %>)</h4>
          <% for (let review of listing.reviews) { %>
          <div class="review-card">
            <div class="review-header">
              <div class="review-author">
                <div class="review-avatar">
                  <%= review.author.username.charAt(0).toUpperCase() %>
                </div>
                <div>
                  <h6 class="mb-0"><%= review.author.username %></h6>
                  <div class="review-rating">
                    <% for(let i = 1; i <= 5; i++) { %>
                      <% if(i <= review.rating) { %>
                        <i class="ri-star-fill text-warning"></i>
                      <% } else { %>
                        <i class="ri-star-line text-warning"></i>
                      <% } %>
                    <% } %>
                    <span class="ms-2 text-muted small">(<%= review.rating %>/5)</span>
                  </div>
                </div>
              </div>
              <small class="text-muted">
                <%= new Date(review.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
              </small>
            </div>
            <div class="review-content">
              <p class="mb-0"><%= review.comment %></p>
            </div>
            <% if (currUser && String(currUser._id) === String(review.author._id)) { %>
            <div class="mt-3">
              <form
                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                method="POST"
                class="d-inline"
              >
                <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Delete this review?')">
                  <i class="ri-delete-bin-line"></i> Delete
                </button>
              </form>
            </div>
            <% } %>
          </div>
          <% } %>
        </div>
        <% } %>
        
        <% if (currUser) { %>
        <div class="card shadow-lg mb-5" style="border-radius: 16px; border: none; overflow: hidden;">
          <div class="card-body p-4">
            <div class="text-center mb-3">
              <h4 class="card-title mb-2" style="font-weight: 700; color: #1e293b; font-size: 1.25rem;">Share Your Experience</h4>
              <p class="text-muted mb-3" style="font-size: 0.9rem;">Help others by sharing your stay experience</p>
            </div>
            <form
              action="/listings/<%= listing._id %>/reviews"
              method="POST"
              class="needs-validation"
              novalidate
            >
              <div class="mb-3">
                <label for="rating" class="form-label fw-bold mb-2">Your Rating</label>
                <div class="d-flex justify-content-center mb-3">
                  <div class="star-rating">
                    <input type="radio" id="rate5" name="review[rating]" value="5">
                    <label for="rate5" class="star-icon">&#9733;</label>
                    <input type="radio" id="rate4" name="review[rating]" value="4">
                    <label for="rate4" class="star-icon">&#9733;</label>
                    <input type="radio" id="rate3" name="review[rating]" value="3">
                    <label for="rate3" class="star-icon">&#9733;</label>
                    <input type="radio" id="rate2" name="review[rating]" value="2">
                    <label for="rate2" class="star-icon">&#9733;</label>
                    <input type="radio" id="rate1" name="review[rating]" value="1">
                    <label for="rate1" class="star-icon">&#9733;</label>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label fw-bold mb-2">Your Review</label>
                <textarea
                  id="comment"
                  name="review[comment]"
                  class="form-control"
                  rows="3"
                  placeholder="Tell us about your experience..."
                  required
                  style="border-radius: 12px; border: 2px solid #e2e8f0; padding: 0.75rem;"
                ></textarea>
                <div class="invalid-feedback">Please share your experience</div>
              </div>
              <button class="btn btn-primary w-100 py-2" type="submit" style="border-radius: 12px; font-weight: 600; letter-spacing: 0.5px;">
                <i class="ri-send-plane-line me-2"></i>Submit Your Review
              </button>
            </form>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script src="/js/map.js"></script>